# 🏢 دليل نظام الوحدات المنفصلة

## 📋 الفكرة الأساسية

عند إضافة **مبنى متعدد الوحدات**، يقوم النظام بـ:

1. ✅ حفظ **العقار الأم** (Parent Property) - معلومات المبنى الأساسية
2. ✅ حفظ **كل وحدة كعقار منفصل** (Unit Property) - لها معرف وإدارة خاصة
3. ✅ نسخ البيانات الأساسية من الأم للوحدات (قابلة للتعديل لاحقاً)

---

## 🔗 العلاقة بين العقار الأم والوحدات

```
🏢 عقار أم (Parent Property)
├── id: "P-123456"
├── referenceNo: "P-123456"
├── isParent: true
├── buildingType: "multi"
├── totalUnits: 5
└── published: false (مخفي - للإدارة فقط)

    ↓ ينشئ ↓

🚪 وحدة A-101 (عقار منفصل)
├── id: "P-123456-UNIT-A101-789456"
├── referenceNo: "UNIT-1234-A101-789456"
├── isUnit: true
├── parentPropertyId: "P-123456"
├── unitNo: "A-101"
├── buildingType: "single"
└── published: true (منشور للعملاء)

🚪 وحدة A-102 (عقار منفصل)
├── id: "P-123456-UNIT-A102-789457"
├── referenceNo: "UNIT-1234-A102-789457"
├── isUnit: true
├── parentPropertyId: "P-123456"
└── ...
```

---

## 📊 البيانات المنسوخة من العقار الأم

عند إنشاء وحدة جديدة، يتم نسخ:

### 1️⃣ معلومات الموقع الأساسية (Location):
- ✅ `province` - المحافظة
- ✅ `state` - الولاية
- ✅ `city` - المدينة
- ✅ `village` - القرية
- ✅ `address` - العنوان (+ "- وحدة A-101")

### 2️⃣ الموقع على الخريطة (GPS):
- ✅ `latitude` - خط العرض
- ✅ `longitude` - خط الطول
- ✅ `mapAddress` - عنوان الخريطة

### 3️⃣ التفاصيل العامة:
- ✅ `usageType` - نوع الاستخدام (سكني، تجاري)
- ✅ `buildingAge` - عمر المبنى
- ✅ `descriptionAr` - الوصف العربي
- ✅ `descriptionEn` - الوصف الإنجليزي

### 4️⃣ المزايا والخدمات:
- ✅ `amenities` - المزايا (مصعد، موقف، حديقة...)
- ✅ `customAmenities` - مزايا مخصصة

### 5️⃣ المعلومات الإدارية:
- ✅ `surveyNumber` - رقم الرسم المساحي
- ✅ `landNumber` - رقم الأرض
- ✅ `notes` - ملاحظات إضافية

### 6️⃣ معلومات المالك:
- ✅ `ownerName` - اسم المالك
- ✅ `ownerPhone` - هاتف المالك
- ✅ `ownerEmail` - بريد المالك

---

## 🔧 البيانات الخاصة بكل وحدة (قابلة للتعديل)

### معلومات فريدة لكل وحدة:
- 🏷️ `unitNo` - رقم الوحدة (A-101, B-205...)
- 🏢 `floor` - الطابق
- 🏠 `type` - نوع الوحدة (شقة، استوديو...)
- 📏 `area` - المساحة
- 🛏️ `beds` - عدد الغرف
- 🛁 `baths` - عدد الحمامات
- 💰 `priceOMR` - السعر
- 💵 `rentalPrice` - سعر الإيجار
- 📸 `images` - صور الوحدة الخاصة
- 📹 `videoUrl` - فيديو الوحدة
- 👤 `tenantName` - اسم المستأجر
- 📅 `leaseEndDate` - تاريخ انتهاء العقد
- ✅ `published` - حالة النشر

---

## 🎯 كيف يعمل النظام؟

### عند إضافة عقار متعدد الوحدات:

#### الخطوة 1: المستخدم يملأ النموذج
```
العنوان: "برج السلام"
الموقع: مسقط - السيب
المزايا: مصعد، موقف، حديقة
الوصف: "برج سكني حديث..."
رقم الرسم: 12345
...

الوحدات:
- A-101: 3 غرف، 120م²، 500 ر.ع
- A-102: 4 غرف، 150م²، 650 ر.ع
- B-201: 2 غرف، 90م²، 400 ر.ع
```

#### الخطوة 2: النظام يحفظ:

**عقار أم واحد:**
```json
{
  "id": "P-20250123-001",
  "referenceNo": "P-20250123-001",
  "isParent": true,
  "titleAr": "برج السلام",
  "province": "مسقط",
  "state": "السيب",
  "amenities": ["elevator", "parking", "garden"],
  "surveyNumber": "12345",
  "published": false,
  "totalUnits": 3
}
```

**3 عقارات منفصلة للوحدات:**
```json
[
  {
    "id": "P-20250123-001-UNIT-A101-789456",
    "referenceNo": "UNIT-0001-A101-789456",
    "isUnit": true,
    "parentPropertyId": "P-20250123-001",
    "unitNo": "A-101",
    "titleAr": "وحدة A-101 - برج السلام",
    "province": "مسقط",  // منسوخ
    "state": "السيب",     // منسوخ
    "amenities": ["elevator", "parking", "garden"],  // منسوخ
    "surveyNumber": "12345",  // منسوخ
    "area": "120",  // خاص بالوحدة
    "beds": "3",    // خاص بالوحدة
    "rentalPrice": "500",  // خاص بالوحدة
    "images": [...],  // خاص بالوحدة
    "published": true  // منشور للعملاء
  },
  {
    "id": "P-20250123-001-UNIT-A102-789457",
    "referenceNo": "UNIT-0001-A102-789457",
    // ... نفس البيانات المنسوخة + تفاصيل الوحدة
  }
]
```

---

## 🔄 كيف تعمل الأزرار؟

### زر "عرض" 👁️:
```
/properties/UNIT-0001-A101-789456
```
- يعرض **تفاصيل الوحدة فقط**
- **ليس** العقار الأم

### زر "تعديل" ✏️:
```
/properties/UNIT-0001-A101-789456/edit
```
- يحرر **الوحدة فقط**
- يمكنك تعديل:
  - عنوان الوحدة
  - الوصف
  - المزايا
  - الموقع (إذا اختلف)
  - ملاحظات الوحدة
  - ... كل شيء

### زر "نشر/إخفاء" 🌐:
```
PATCH /api/units/UNIT-0001-A101-789456
{ "published": true/false }
```
- ينشر/يخفي **الوحدة فقط**
- العقار الأم يبقى كما هو

### زر "أرشفة" 📦:
```
PATCH /api/units/UNIT-0001-A101-789456
{ "status": "archived", "published": false }
```
- يؤرشف **الوحدة فقط**

### زر "حذف" 🗑️:
```
DELETE /api/units/UNIT-0001-A101-789456
```
- يحذف **الوحدة فقط**
- العقار الأم والوحدات الأخرى تبقى

---

## 🎨 في واجهة `/properties/unified-management`:

### عرض المبنى:
```
┌────────────────────────────────────┐
│  🏢 برج السلام (العقار الأم)      │
│  📍 مسقط - السيب                  │
│  📊 3 وحدات                        │
│  [عرض الوحدات ▼]                  │
└────────────────────────────────────┘
         ↓
┌────────────────────────────────────┐
│  ☑️ تحديد الكل (3 وحدات)          │
├────────────────────────────────────┤
│  🚪 وحدة A-101                     │
│     UNIT-0001-A101-789456 [نسخ]    │
│     📏 120م² | 🛏️ 3 | 💰 500 ر.ع   │
│     [عرض][تعديل][نشر][أرشفة][حذف]│
├────────────────────────────────────┤
│  🚪 وحدة A-102                     │
│     UNIT-0001-A102-789457 [نسخ]    │
│     ...                            │
└────────────────────────────────────┘
```

---

## 📝 ملاحظات مهمة

### 1️⃣ العقار الأم:
- **مخفي** عن العملاء (published: false)
- يستخدم **للإدارة فقط**
- يحتوي على المعلومات المشتركة

### 2️⃣ الوحدات:
- **منشورة** للعملاء (published: true)
- كل وحدة **عقار مستقل** تماماً
- يمكن تعديلها بدون التأثير على الأم

### 3️⃣ نسخ البيانات:
- البيانات **تُنسخ مرة واحدة** عند الإنشاء
- بعد ذلك **كل وحدة مستقلة**
- تعديل الوحدة **لا يؤثر** على الأم
- تعديل الأم **لا يؤثر** على الوحدات

### 4️⃣ الأرقام المتسلسلة:
```
العقار الأم: P-20250123-001
الوحدة A-101: UNIT-0001-A101-789456
الوحدة A-102: UNIT-0001-A102-789457
```

---

## 🚀 كيفية الاستخدام

### 1️⃣ إضافة مبنى جديد:
```
1. اذهب إلى /properties/new
2. اختر "مبنى متعدد الوحدات"
3. املأ معلومات المبنى:
   - العنوان
   - الموقع
   - المزايا
   - الوصف
   - رقم الرسم المساحي
   - ...
4. أضف الوحدات:
   - وحدة A-101
   - وحدة A-102
   - ...
5. احفظ
```

**النتيجة:**
- ✅ عقار أم واحد (مخفي)
- ✅ X عقارات منفصلة للوحدات (منشورة)

### 2️⃣ إدارة الوحدات:
```
1. اذهب إلى /properties/unified-management
2. ابحث عن المبنى
3. اضغط "عرض الوحدات"
4. كل وحدة لها أزرارها:
   - عرض → صفحة الوحدة فقط
   - تعديل → تعديل الوحدة فقط
   - نشر/إخفاء → الوحدة فقط
   - أرشفة → الوحدة فقط
   - حذف → الوحدة فقط
```

### 3️⃣ تعديل وحدة:
```
1. اضغط "تعديل" على الوحدة
2. ستفتح صفحة التعديل للوحدة
3. جميع البيانات قابلة للتعديل:
   - العنوان (يمكنك تغييره!)
   - الوصف (يمكنك تخصيصه!)
   - المزايا (يمكنك إضافة/حذف!)
   - الموقع (إذا اختلف!)
   - ملاحظات خاصة بالوحدة
4. احفظ
```

**النتيجة:** تتحدث **الوحدة فقط** ✅

---

## 🎯 مثال عملي

### السيناريو:
لديك **برج السلام** به 10 وحدات.

### قبل النظام الجديد ❌:
```
- 1 عقار فقط
- الوحدات مخزنة داخل units[]
- لا يمكن إدارة كل وحدة منفصلة
- تعديل الوحدة يعني تعديل العقار كله
```

### مع النظام الجديد ✅:
```
- 11 عقار:
  - 1 عقار أم (Parent)
  - 10 عقارات للوحدات (Units)
  
- كل وحدة مستقلة تماماً
- يمكنك:
  ✅ عرض تفاصيل الوحدة A-101 فقط
  ✅ تعديل وصف الوحدة B-205 فقط
  ✅ نشر الوحدة C-301 وإخفاء D-402
  ✅ تأجير كل وحدة لمستأجر مختلف
  ✅ أرشفة/حذف وحدات محددة
```

---

## 📁 الملفات

### الملفات الجديدة:
```
src/lib/unitPropertySystem.ts        - نظام الوحدات
src/lib/propertyUnitConverter.ts     - تحويل ونسخ البيانات
src/pages/api/units/[id].ts          - API إدارة الوحدات
src/components/property/BuildingUnitsManager.tsx - مكون العرض
```

### APIs:
```
GET    /api/units/[id]        - عرض الوحدة
PUT    /api/units/[id]        - تحديث الوحدة
PATCH  /api/units/[id]        - تحديث جزئي (نشر، أرشفة)
DELETE /api/units/[id]        - حذف الوحدة
```

---

## ✅ المميزات

1. ✅ **كل وحدة عقار منفصل** - لها صفحتها الخاصة
2. ✅ **رقم متسلسل فريد** - UNIT-XXXX-XXXX-XXXXXX
3. ✅ **نسخ تلقائي** - للبيانات الأساسية من الأم
4. ✅ **قابل للتعديل** - كل وحدة يمكن تخصيصها
5. ✅ **إدارة منفصلة** - عرض، تعديل، نشر، أرشفة، حذف
6. ✅ **تأجير مرن** - كل وحدة لمستأجر مختلف
7. ✅ **عرض احترافي** - في unified-management
8. ✅ **تحديد جماعي** - لعمليات على عدة وحدات

---

## 🔄 الحالة الحالية

⚠️ **النظام جاهز للاختبار!**

لكن يجب تحديث:
- ✅ `/properties/new` - لحفظ الوحدات المنفصلة
- ✅ `/properties/[id]/edit` - لتحديث العقار الأم + الوحدات
- ✅ `/properties/unified-management` - يعمل بالفعل!

---

**📅 تاريخ الإنشاء:** 23 يناير 2025  
**🎯 الحالة:** ✅ جاهز للتطوير الكامل

