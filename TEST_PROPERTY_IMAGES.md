# ๐งช ุฏููู ุงุฎุชุจุงุฑ ูุธุงู ุงูุตูุฑ ูู ุงูุนูุงุฑุงุช

## โ ุงูุฅุตูุงุญุงุช ุงููุทุจูุฉ:

### **1. API Backend (`src/pages/api/properties/[id].tsx`):**
- โ `import formidable from "formidable"` - ุงุณุชูุฑุงุฏ ุตุญูุญ
- โ `export const config = { api: { bodyParser: false } }` - ุชุนุทูู bodyParser
- โ `formidable({ ... })` - ุงุณุชุฎุฏุงู ูุจุงุดุฑ (ููุณ index.ts)
- โ ูุนุงูุฌุฉ `existingImages` + `files.images` ุฌุฏูุฏุฉ
- โ ุฏูุฌ ุงูุตูุฑ ุงูููุฌูุฏุฉ + ุงูุฌุฏูุฏุฉ ูู `finalImages`
- โ ูุฑุงุกุฉ JSON body ูุฏููุงู ุนูุฏูุง ูุง ููุฌุฏ multipart

### **2. Frontend (`src/pages/properties/[id]/edit.tsx`):**
- โ ููุน ุงูุจูุงูุงุช: `images: (File | string)[]`
- โ ุชุญููู ุงูุตูุฑ ูู URLs (strings) ุจุฏูู ุชุญููู ูู Files
- โ ุนุฑุถ ุงูุตูุฑ: ุฏุนู `typeof img === 'string' ? img : URL.createObjectURL(img)`
- โ ุถุบุท ุงูุตูุฑ ูุจู ุงูุฑูุน (ุชูููุฑ 50-80%)
- โ ุฅุฑุณุงู FormData ุนูุฏ ูุฌูุฏ Files ุฌุฏูุฏุฉ
- โ ุฅุฑุณุงู JSON ุนูุฏ ุนุฏู ูุฌูุฏ Files ุฌุฏูุฏุฉ
- โ ูุคุดุฑ ุชูุฏู ุญู
- โ Error handling ุดุงูู

### **3. API Index (`src/pages/api/properties/index.ts`):**
- โ `published: true` ุงูุชุฑุงุถูุงู ููุนูุงุฑุงุช ุงูุฌุฏูุฏุฉ
- โ ุฅุฑุฌุงุน `{ properties: [...], items: [...] }` (ุฏุนู ููุง ุงูุชูุณูููู)

---

## ๐ ุฎุทุฉ ุงูุงุฎุชุจุงุฑ ุงูุดุงููุฉ:

### **ุงุฎุชุจุงุฑ 1: ุฅูุดุงุก ุนูุงุฑ ุฌุฏูุฏ ูุน ุตูุฑ**

**ุงูุฎุทูุงุช:**
1. ุงูุชุญ: `http://localhost:3000/properties/new`
2. ุงููุฃ ุงูุจูุงูุงุช ุงูุฃุณุงุณูุฉ
3. ุฃุถู 2-3 ุตูุฑ
4. ุงุถุบุท "ุญูุธ"

**ุงููุชูุฌุฉ ุงููุชููุนุฉ:**
- โ ุงูุตูุฑ ุชูุถุบูุท (ุฑุงูุจ Console)
- โ ุฑุณุงูุฉ "ุชู ุญูุธ ุงูุนูุงุฑ ุจูุฌุงุญ!"
- โ ุฅุนุงุฏุฉ ุชูุฌูู ูุตูุญุฉ ุงูุฅุฏุงุฑุฉ
- โ ุงูุนูุงุฑ ูุธูุฑ ูู ุงููุงุฆูุฉ
- โ `published: true` ุชููุงุฆูุงู

---

### **ุงุฎุชุจุงุฑ 2: ุชุนุฏูู ุนูุงุฑ ุจุฏูู ุชุบููุฑ ุงูุตูุฑ**

**ุงูุฎุทูุงุช:**
1. ุงูุชุญ ุนูุงุฑ ููุฌูุฏ: `http://localhost:3000/properties/P-.../edit`
2. ุนุฏูู ุงูุนููุงู ููุท
3. **ูุง ุชููุณ ุงูุตูุฑ**
4. ุงุถุบุท "ุญูุธ"

**ุงููุชูุฌุฉ ุงููุชููุนุฉ:**
- โ ููุฑุณูู JSON (ููุณ FormData)
- โ ุงูุตูุฑ ุชุจูู ููุง ูู
- โ ุฑุณุงูุฉ ูุฌุงุญ
- ูู Terminal:
  ```
  ๐ Parsed JSON body, keys: [...]
  ๐ผ๏ธ Images before upsert: ['/uploads/...']
  โ Property updated, images: ['/uploads/...']
  ```

---

### **ุงุฎุชุจุงุฑ 3: ุชุนุฏูู ุนูุงุฑ + ุฅุถุงูุฉ ุตูุฑ ุฌุฏูุฏุฉ**

**ุงูุฎุทูุงุช:**
1. ุงูุชุญ ุนูุงุฑ ููุฌูุฏ ูู ุตูุฑ: `http://localhost:3000/properties/P-.../edit`
2. ุฃุถู 1-2 ุตูุฑุฉ ุฌุฏูุฏุฉ
3. ุงุถุบุท "ุญูุธ"

**ุงููุชูุฌุฉ ุงููุชููุนุฉ:**
- โ ููุฑุณูู FormData (ูุฃู ููุงู Files)
- โ ุงูุตูุฑ ุงููุฏููุฉ ุชูุฑุณูู ูู `existingImages`
- โ ุงูุตูุฑ ุงูุฌุฏูุฏุฉ ุชูุถุบูุท ูุชูุฑููุน
- โ ูุชู ุฏูุฌูู
- ูู Terminal:
  ```
  โ FormData parsed successfully
  ๐ธ Restored existing images: 3
  ๐ Added new images: 2
  ๐ Total images in body: 5
  โ Property updated, images: [5 items]
  ```

---

### **ุงุฎุชุจุงุฑ 4: ุญุฐู ุตูุฑุฉ ูู ุนูุงุฑ ููุฌูุฏ**

**ุงูุฎุทูุงุช:**
1. ุงูุชุญ ุนูุงุฑ ูู ุตูุฑ: `http://localhost:3000/properties/P-.../edit`
2. ุงุญุฐู ุตูุฑุฉ ูุงุญุฏุฉ (ุฒุฑ X)
3. ุงุถุบุท "ุญูุธ"

**ุงููุชูุฌุฉ ุงููุชููุนุฉ:**
- โ ููุฑุณูู JSON (ูุง ุชูุฌุฏ Files ุฌุฏูุฏุฉ)
- โ ุงูุตูุฑ ุงููุชุจููุฉ ููุท ุชูุญููุธ
- โ ุงูุตูุฑุฉ ุงููุญุฐููุฉ ูุง ุชุธูุฑ

---

## ๐ ููุงุท ุงูุชุดุฎูุต:

### **ูู Console ุงููุชุตูุญ:**
```javascript
// ุนูุฏ ุงูุญูุธ ุจุฏูู ุตูุฑ ุฌุฏูุฏุฉ:
๐ค Sending data to API:
๐ผ๏ธ Images count: 3
๐ผ๏ธ Images: ["/uploads/...", "/uploads/...", "/uploads/..."]

// ุนูุฏ ุงูุญูุธ ูุน ุตูุฑ ุฌุฏูุฏุฉ:
๐๏ธ Compressing images...
  image1.jpg: 2500.0KB โ 450.0KB
โ Compression complete!
๐ค Sending FormData with:
  - Existing images: 3
  - New files: 1
```

### **ูู Terminal:**
```javascript
// FormData route:
โ FormData parsed successfully
๐ Fields keys: ['titleAr', 'titleEn', ...]
๐ Files keys: ['images']
๐ธ Restored existing images: 3
๐ Added new images: 1
๐ Total images in body: 4
๐ผ๏ธ Images before upsert: ['/uploads/...', ...]
โ Property updated, images: [4 items]
PUT /api/properties/P-... 200 in 2000ms

// JSON route:
๐ Parsed JSON body, keys: [...]
๐ผ๏ธ Images before upsert: ['/uploads/...', ...]
โ Property updated, images: [3 items]
PUT /api/properties/P-... 200 in 50ms
```

---

## โ ุงูุฃุฎุทุงุก ุงููุญุชููุฉ ูุญููููุง:

### **ุฎุทุฃ: "formidable is not a function"**
**ุงูุณุจุจ:** ุงุณุชูุฑุงุฏ ุฃู ุงุณุชุฎุฏุงู ุฎุงุทุฆ  
**ุงูุญู:** ุงุณุชุฎุฏุงู `formidable({ ... })` ูุจุงุดุฑุฉ (ุชู โ)

### **ุฎุทุฃ: "Failed to fetch"**
**ุงูุณุจุจ:** ุงููุทุงุน ุดุจูุฉ ุฃู timeout  
**ุงูุญู:** ุถุบุท ุงูุตูุฑ + timeout ุฃุทูู (ุชู โ)

### **ุฎุทุฃ: ุงูุตูุฑ ุชุฎุชูู**
**ุงูุณุจุจ:** ุฅุฑุณุงู URLs ูู Files  
**ุงูุญู:** ูุตู existingImages + newFiles (ุชู โ)

---

## โ Checklist ุงูููุงุฆู:

- [x] formidable ูุณุชุฎุฏู ุจุดูู ุตุญูุญ
- [x] bodyParser ูุนุทู ูู API
- [x] ูุฑุงุกุฉ JSON ูุฏููุงู
- [x] ูุนุงูุฌุฉ FormData ุตุญูุญุฉ
- [x] ุถุบุท ุงูุตูุฑ ูุจู ุงูุฑูุน
- [x] ุงูุญูุงุธ ุนูู ุงูุตูุฑ ุงูููุฌูุฏุฉ
- [x] ูุคุดุฑ ุชูุฏู ูุงุถุญ
- [x] Error handling ุดุงูู
- [ ] **ุงูุงุฎุชุจุงุฑ ุงููุนูู** โ ุงูุชุงูู

---

**ุชุงุฑูุฎ:** 2025-10-22  
**ุงูุญุงูุฉ:** โ ุฌุงูุฒ ููุงุฎุชุจุงุฑ ุงูููุงุฆู

