# 🧪 دليل اختبار نظام الصلاحيات

## 📋 خطوات الاختبار

### ✅ الاختبار 1: حذف جميع صلاحيات الباقة الأساسية

**الخطوات:**
```
1. افتح: http://localhost:3000/admin/subscriptions
2. ابحث عن عمود "الخطة الأساسية"
3. أزل جميع علامات ✓ من الصلاحيات
4. اضغط "حفظ جميع التغييرات"
5. ✅ يجب أن تظهر: "تم حفظ التغييرات بنجاح!"
```

**التحقق:**
```
6. افتح: http://localhost:3000/property/P-20251012145418/admin
7. ✅ يجب أن ترى:
   - فقط تبويب "نظرة عامة" (إذا كانت مفعلة)
   - أو رسالة "ميزة إضافية مقفلة" تحتوي على:
     * عدد الميزات المقفلة
     * أسماء الميزات المقفلة
     * زر "ترقية الباقة"
```

---

### ✅ الاختبار 2: إضافة صلاحية واحدة فقط

**الخطوات:**
```
1. في http://localhost:3000/admin/subscriptions
2. ضع ✓ فقط على "نظرة عامة" للباقة الأساسية
3. احفظ التغييرات
4. افتح Console (F12) لرؤية الرسائل
```

**التحقق:**
```
5. افتح: http://localhost:3000/property/P-20251012145418/admin
6. في Console يجب أن ترى:
   ✅ قراءة صلاحيات basic من localStorage: ["OVERVIEW"]
   🔍 التحقق من OVERVIEW للمستخدم (basic): true
   🔍 التحقق من TASKS_VIEW للمستخدم (basic): false
   ...

7. في الواجهة:
   ✅ تبويب "نظرة عامة" يظهر
   ❌ جميع التبويبات الأخرى مخفية
   ✅ رسالة "11 ميزة إضافية مقفلة"
```

---

### ✅ الاختبار 3: تفعيل صلاحيات متعددة

**الخطوات:**
```
1. في http://localhost:3000/admin/subscriptions
2. للباقة الأساسية، ضع ✓ على:
   - نظرة عامة
   - عرض المهام
   - عرض الفواتير
   - عرض العقود
3. احفظ
```

**التحقق:**
```
4. حدّث صفحة: http://localhost:3000/property/P-20251012145418/admin
5. ✅ يجب أن تظهر 4 تبويبات فقط:
   - نظرة عامة
   - المهام
   - الفواتير والمدفوعات
   - العقود
6. ❌ التبويبات الأخرى مخفية
7. ✅ رسالة "8 ميزة إضافية مقفلة"
```

---

### ✅ الاختبار 4: تعيين باقة للمستخدم

**الخطوات:**
```
1. في http://localhost:3000/admin/subscriptions
2. انزل لقسم "إدارة اشتراكات المستخدمين"
3. اضغط على زر "الخطة المعيارية" (79 ر.ع)
4. ✅ يجب أن تظهر: "تم تعيين الباقة بنجاح!"
```

**التحقق:**
```
5. حدّث صفحة: http://localhost:3000/property/P-20251012145418/admin
6. ✅ يجب أن تظهر جميع تبويبات الباقة المعيارية (19 ميزة)
7. في Console:
   ✅ قراءة صلاحيات standard من localStorage
   🔍 جميع الصلاحيات المعيارية = true
```

---

### ✅ الاختبار 5: اختبار صفحة Profile

**الخطوات:**
```
1. في http://localhost:3000/admin/subscriptions
2. أزل ✓ من "القضايا القانونية" في الباقة الأساسية
3. احفظ
4. عيّن المستخدم للباقة الأساسية
```

**التحقق:**
```
5. افتح: http://localhost:3000/profile
6. ✅ قسم "القضايا القانونية" يجب أن يكون مقفلاً
7. ✅ يظهر رسالة "ميزة مميزة" مع زر ترقية
```

---

## 🔍 رسائل Console المتوقعة

### عند فتح صفحة إدارة العقار:

```javascript
✅ قراءة صلاحيات basic من localStorage: ["OVERVIEW", "INVOICES_VIEW"]
🔍 تحميل صلاحيات متعددة لـ basic: {
  OVERVIEW: true,
  TASKS_VIEW: false,
  LEASES_VIEW: false,
  INVOICES_VIEW: true,
  MAINTENANCE_VIEW: false,
  LEGAL_VIEW: false,
  ...
}
```

### عند الحفظ من صفحة الإدارة:

```javascript
💾 تم حفظ الصلاحيات: {
  basic: ["OVERVIEW", "INVOICES_VIEW"],
  standard: ["OVERVIEW", "TASKS_VIEW", ...],
  ...
}
```

### عند تحديث الصفحة:

```javascript
🔄 تحديث الصلاحيات بعد التغيير
```

---

## ⚠️ مشاكل محتملة وحلولها

### المشكلة 1: التغييرات لا تظهر

**السبب:** الصفحة لم تتحدث  
**الحل:** اضغط F5 لتحديث الصفحة يدوياً

---

### المشكلة 2: جميع الصلاحيات تظهر حتى بعد الحذف

**السبب:** localStorage لم يتم تحديثه  
**الحل:**
```javascript
// افتح Console (F12) واكتب:
localStorage.removeItem('custom_plan_features');
location.reload();
```

---

### المشكلة 3: "قراءة صلاحيات من الافتراضي" بدلاً من localStorage

**السبب:** اسم الباقة غير صحيح أو localStorage فارغ  
**الحل:**
```javascript
// تحقق من localStorage:
console.log(localStorage.getItem('custom_plan_features'));

// يجب أن ترى:
{"basic":["OVERVIEW"],"standard":[...],...}
```

---

## ✅ السلوك المتوقع

### سيناريو: باقة أساسية بدون صلاحيات

```
الباقة: Basic
الصلاحيات: [] (فارغة)

النتيجة:
├─ /property/[id]/admin
│  └─ ❌ جميع التبويبات مخفية
│  └─ ✅ رسالة "12 ميزة إضافية مقفلة"
│
└─ /profile
   └─ ❌ جميع الأقسام مقفلة
   └─ ✅ رسائل ترقية تظهر
```

### سيناريو: باقة أساسية مع صلاحية واحدة

```
الباقة: Basic
الصلاحيات: ["OVERVIEW"]

النتيجة:
├─ /property/[id]/admin
│  └─ ✅ تبويب "نظرة عامة" فقط
│  └─ ❌ 11 تبويب مخفي
│  └─ ✅ رسالة "11 ميزة إضافية مقفلة"
│
└─ /profile
   └─ ✅ قسم النظرة العامة يظهر
   └─ ❌ باقي الأقسام مقفلة
```

### سيناريو: باقة معيارية كاملة

```
الباقة: Standard
الصلاحيات: 19 صلاحية (كل Standard)

النتيجة:
├─ /property/[id]/admin
│  └─ ✅ 10 تبويبات تظهر
│  └─ ❌ 2 تبويب مخفي (القانونية، الذكاء)
│  └─ ✅ رسالة "2 ميزة إضافية مقفلة"
│
└─ /profile
   └─ ✅ معظم الأقسام تظهر
   └─ ❌ القانونية والذكاء مقفلة
```

---

## 🎯 نقاط التحقق السريعة

✅ **1. حفظ الصلاحيات:**
- localStorage.getItem('custom_plan_features') يحتوي على البيانات

✅ **2. قراءة الصلاحيات:**
- Console يظهر "✅ قراءة صلاحيات من localStorage"

✅ **3. تطبيق الصلاحيات:**
- التبويبات المخفية فعلاً مخفية

✅ **4. رسالة الترقية:**
- تظهر عدد وأسماء الميزات المقفلة

✅ **5. زر الترقية:**
- يوجه إلى /subscriptions

---

## 🚀 الأوامر المفيدة للاختبار

### عرض الصلاحيات المحفوظة:
```javascript
// في Console:
JSON.parse(localStorage.getItem('custom_plan_features'))
```

### إعادة تعيين للإعدادات الافتراضية:
```javascript
localStorage.removeItem('custom_plan_features');
location.reload();
```

### التحقق من باقة المستخدم:
```javascript
const user = JSON.parse(localStorage.getItem('ain_auth'));
console.log('الباقة الحالية:', user.subscription?.planId);
```

---

**تم إنشاؤه:** 12 أكتوبر 2025  
**الغرض:** اختبار نظام الصلاحيات  
**الحالة:** جاهز للاختبار ✅

